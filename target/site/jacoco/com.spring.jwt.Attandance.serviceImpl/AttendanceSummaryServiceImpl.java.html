<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AttendanceSummaryServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JWT-with-Spring-Security</a> &gt; <a href="index.source.html" class="el_package">com.spring.jwt.Attandance.serviceImpl</a> &gt; <span class="el_source">AttendanceSummaryServiceImpl.java</span></div><h1>AttendanceSummaryServiceImpl.java</h1><pre class="source lang-java linenums">package com.spring.jwt.Attandance.serviceImpl;

import com.spring.jwt.Attandance.Dto.AttendanceSummaryDailyDto;
import com.spring.jwt.Attandance.Dto.AttendanceSummaryDto;
import com.spring.jwt.Attandance.Dto.MonthlyAttendanceReportDto;
import com.spring.jwt.Attandance.entity.AttendanceSummary;
import com.spring.jwt.Attandance.repo.AttendanceSummaryRepository;
import com.spring.jwt.Attandance.Service.AttendanceSummaryService;
import com.spring.jwt.exception.ResourceNotFoundException;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.BeanUtils;
import org.springframework.stereotype.Service;

import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
<span class="nc" id="L20">@RequiredArgsConstructor</span>
public class AttendanceSummaryServiceImpl implements AttendanceSummaryService {

    private final AttendanceSummaryRepository repo;

    /**
     * Saves a new attendance summary and returns the updated data transfer object.
     *
     * Copies properties from the provided DTO to a new entity, persists it, and updates the DTO with any generated values before returning.
     *
     * @param dto the attendance summary data to save
     * @return the updated attendance summary DTO with persisted values
     */
    @Override
    public AttendanceSummaryDto saveSummary(AttendanceSummaryDto dto) {
<span class="nc" id="L35">        AttendanceSummary entity = new AttendanceSummary();</span>
<span class="nc" id="L36">        BeanUtils.copyProperties(dto, entity);</span>
<span class="nc" id="L37">        AttendanceSummary saved = repo.save(entity);</span>
<span class="nc" id="L38">        BeanUtils.copyProperties(saved, dto);</span>
<span class="nc" id="L39">        return dto;</span>
    }

    /**
     * Retrieves an attendance summary by its unique ID.
     *
     * @param id the unique identifier of the attendance summary
     * @return the attendance summary data transfer object corresponding to the given ID
     * @throws ResourceNotFoundException if no attendance summary is found with the specified ID
     */
    @Override
    public AttendanceSummaryDto getSummaryById(Long id) {
<span class="nc" id="L51">        AttendanceSummary entity = repo.findById(id)</span>
<span class="nc" id="L52">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;AttendanceSummary not found&quot;));</span>
<span class="nc" id="L53">        AttendanceSummaryDto dto = new AttendanceSummaryDto();</span>
<span class="nc" id="L54">        BeanUtils.copyProperties(entity, dto);</span>
<span class="nc" id="L55">        return dto;</span>
    }

    /**
     * Retrieves all attendance summaries as a list of data transfer objects.
     *
     * @return a list of AttendanceSummaryDto objects representing all attendance summaries
     */
    @Override
    public List&lt;AttendanceSummaryDto&gt; getAllSummaries() {
<span class="nc" id="L65">        return repo.findAll().stream().map(summary -&gt; {</span>
<span class="nc" id="L66">            AttendanceSummaryDto dto = new AttendanceSummaryDto();</span>
<span class="nc" id="L67">            BeanUtils.copyProperties(summary, dto);</span>
<span class="nc" id="L68">            return dto;</span>
<span class="nc" id="L69">        }).collect(Collectors.toList());</span>
    }

    /**
     * Updates an existing attendance summary with new data.
     *
     * @param id the unique identifier of the attendance summary to update
     * @param dto the DTO containing the updated attendance summary information
     * @return the DTO reflecting the updated attendance summary
     * @throws ResourceNotFoundException if no attendance summary with the given ID is found
     */
    @Override
    public AttendanceSummaryDto updateSummary(Long id, AttendanceSummaryDto dto) {
<span class="nc" id="L82">        AttendanceSummary entity = repo.findById(id)</span>
<span class="nc" id="L83">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;AttendanceSummary not found&quot;));</span>
<span class="nc" id="L84">        BeanUtils.copyProperties(dto, entity);</span>
<span class="nc" id="L85">        entity.setId(id);</span>
<span class="nc" id="L86">        repo.save(entity);</span>
<span class="nc" id="L87">        return dto;</span>
    }
    /**
     * Generates a monthly attendance report for a specific user and month.
     *
     * Retrieves all attendance summaries for the given user, filters them by the specified month (formatted as &quot;yyyy-MM&quot;),
     * and calculates the number of present, half-day, and absent days. Constructs a detailed report including daily attendance
     * summaries and a total present equivalent (present days plus half of half-days).
     *
     * @param userId the ID of the user whose attendance is being reported
     * @param month the month for the report in &quot;yyyy-MM&quot; format
     * @return a MonthlyAttendanceReportDto containing attendance statistics and daily summaries for the specified month
     */
    @Override
    public MonthlyAttendanceReportDto getMonthlyAttendanceReport(Long userId, String month) {
<span class="nc" id="L102">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;yyyy-MM&quot;);</span>

        // Get all records for the user
<span class="nc" id="L105">        List&lt;AttendanceSummary&gt; allSummaries = repo.findByUserId(userId);</span>

        // Filter by month (yyyy-MM format)
<span class="nc" id="L108">        List&lt;AttendanceSummary&gt; summaries = allSummaries.stream()</span>
<span class="nc bnc" id="L109" title="All 4 branches missed.">                .filter(summary -&gt; summary.getDate() != null &amp;&amp; summary.getDate().format(formatter).equals(month))</span>
<span class="nc" id="L110">                .collect(Collectors.toList());</span>

        // Initialize counters
<span class="nc" id="L113">        int present = 0;</span>
<span class="nc" id="L114">        int halfDay = 0;</span>
<span class="nc" id="L115">        int absent = 0;</span>

        // Prepare daily summary list
<span class="nc" id="L118">        List&lt;AttendanceSummaryDailyDto&gt; dailyDtos = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">        for (AttendanceSummary summary : summaries) {</span>
<span class="nc" id="L121">            AttendanceSummaryDailyDto dto = new AttendanceSummaryDailyDto();</span>
<span class="nc" id="L122">            dto.setDate(summary.getDate());</span>
<span class="nc" id="L123">            dto.setTotalWorkingHours(summary.getTotalWorkingHours());</span>
<span class="nc" id="L124">            dto.setAttendanceStatus(summary.getAttendanceStatus());</span>

<span class="nc" id="L126">            String status = summary.getAttendanceStatus();</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (status != null) {</span>
<span class="nc bnc" id="L128" title="All 4 branches missed.">                switch (status.toLowerCase()) {</span>
                    case &quot;present&quot;:
<span class="nc" id="L130">                        present++;</span>
<span class="nc" id="L131">                        break;</span>
                    case &quot;half day&quot;:
<span class="nc" id="L133">                        halfDay++;</span>
<span class="nc" id="L134">                        break;</span>
                    case &quot;absent&quot;:
<span class="nc" id="L136">                        absent++;</span>
                        break;
                    // You can handle more statuses here if needed
                }
            }

<span class="nc" id="L142">            dailyDtos.add(dto);</span>
<span class="nc" id="L143">        }</span>

        // Prepare final report DTO
<span class="nc" id="L146">        MonthlyAttendanceReportDto report = new MonthlyAttendanceReportDto();</span>
<span class="nc" id="L147">        report.setUserId(userId);</span>
<span class="nc" id="L148">        report.setMonth(month);</span>
<span class="nc" id="L149">        report.setPresentDays(present);</span>
<span class="nc" id="L150">        report.setHalfDays(halfDay);</span>
<span class="nc" id="L151">        report.setAbsentDays(absent);</span>
<span class="nc" id="L152">        report.setTotalPresentEquivalent(present + (halfDay / 2.0));</span>
<span class="nc" id="L153">        report.setDailySummaries(dailyDtos);</span>

<span class="nc" id="L155">        return report;</span>
    }




}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>